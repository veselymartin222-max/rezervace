require('dotenv').config();
const express = require('express');
const cors = require('cors');
const { createClient } = require('@supabase/supabase-js');
const twilio = require('twilio');

const app = express();
app.use(cors());
app.use(express.json());
app.use(express.static(__dirname));

const supabase = createClient(
    process.env.SUPABASE_URL,
    process.env.SUPABASE_KEY
);

const client = twilio(
    process.env.TWILIO_SID,
    process.env.TWILIO_TOKEN
);

// --- 1. VYTVOÅ˜ENÃ REZERVACE ---
app.post('/reserve', async (req, res) => {
    const { name, date, time_from, time_to } = req.body;

    const { data: existing, error: searchError } = await supabase
        .from('reservations')
        .select('*')
        .eq('date', date)
        .filter('time_from', 'lt', time_to)
        .filter('time_to', 'gt', time_from);

    if (existing && existing.length > 0) {
        return res.json({ success: false, message: "Tento Äas je uÅ¾ obsazenÃ½!" });
    }

    const token = Math.random().toString(36).substring(2, 10).toUpperCase();

    const { error: insertError } = await supabase
        .from('reservations')
        .insert([{ name, date, time_from, time_to, secret_token: token }]);

    if (insertError) {
        return res.json({ success: false, error: insertError.message });
    }

    try {
        await client.messages.create({
            from: process.env.TWILIO_FROM,
            to: process.env.ADMIN_TO,
            body: `âœ… NovÃ¡ rezervace: ${name}\nðŸ“… ${date}\nâ° ${time_from} - ${time_to}\nðŸ”‘ KÃ³d: ${token}`
        });
    } catch (err) {
        console.log("Twilio Error:", err.message);
    }

    res.json({ success: true, token: token });
});

// --- 2. ZÃSKÃNÃ REZERVACÃ ---
app.get('/reservations', async (req, res) => {
    const { date } = req.query;
    let query = supabase.from('reservations').select('*');
    
    if (date) {
        query = query.eq('date', date);
    }

    const { data, error } = await query.order('time_from', { ascending: true });

    if (error) return res.status(500).json({ error: error.message });
    res.json(data);
});

// --- 3. MAZÃNÃ ADMINEM ---
app.post('/delete', async (req, res) => {
    const { id, adminPassword } = req.body;

    // Normalizace hesel pro jistotu
    const storedPassword = String(process.env.ADMIN_PASSWORD).trim();
    const providedPassword = String(adminPassword).trim();

    if (!providedPassword || providedPassword !== storedPassword) {
        return res.status(401).json({ success: false, message: "Å patnÃ© heslo!" });
    }

    const { error } = await supabase.from('reservations').delete().eq('id', id);

    if (error) return res.status(500).json({ success: false, error: error.message });
    res.json({ success: true });
});

// --- 4. MAZÃNÃ UÅ½IVATELEM (KÃ³d/Token) ---
app.post('/delete-own', async (req, res) => {
    let { token } = req.body;

    if (!token) return res.json({ success: false, message: "ChybÃ­ kÃ³d." });

    token = token.trim().toUpperCase();
    console.log("Pokus o smazÃ¡nÃ­ tokenem:", token);

    // DÅ¯leÅ¾itÃ©: v Supabase musÃ­ bÃ½t sloupec 'secret_token'
    const { data, error } = await supabase
        .from('reservations')
        .delete()
        .eq('secret_token', token)
        .select(); // Select je nutnÃ½ pro potvrzenÃ­ smazÃ¡nÃ­ v data

    if (error) {
        console.error("Supabase Error:", error.message);
        return res.status(500).json({ success: false, error: error.message });
    }
    
    if (!data || data.length === 0) {
        console.log("Token nenalezen v DB:", token);
        return res.json({ success: false, message: "NeplatnÃ½ kÃ³d!" });
    }

    console.log("ÃšspÄ›Å¡nÄ› smazÃ¡no:", data);
    res.json({ success: true });
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => console.log(`Server bÄ›Å¾Ã­ na portu ${PORT}`));
