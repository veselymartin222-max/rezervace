<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rezervaƒçn√≠ Syst√©m Knihovna</title>
    <style>
        :root {
            --primary-color: #2563eb;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --free-color: #dcfce7;
            --busy-color: #dbeafe;
            --danger-color: #ef4444;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
        }
        .container { width: 100%; max-width: 500px; }
        h1, h2 { text-align: center; color: var(--primary-color); }
        .card {
            background: var(--card-bg); padding: 20px; border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 20px;
        }
        .time-slot {
            display: flex; justify-content: space-between; padding: 12px;
            margin-bottom: 8px; border-radius: 8px; font-weight: 500;
            cursor: pointer; transition: transform 0.15s;
        }
        .time-slot:hover { transform: scale(1.01); }
        .free { background: var(--free-color); }
        .busy { background: var(--busy-color); cursor: default; }
        .input-group { margin-bottom: 15px; }
        label { display: block; font-size: 14px; font-weight: 600; margin-bottom: 5px; }
        input {
            width: 100%; padding: 12px; border: 1px solid #e2e8f0;
            border-radius: 8px; font-size: 16px; box-sizing: border-box;
        }
        .time-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        button {
            width: 100%; padding: 14px; background-color: var(--primary-color);
            color: white; border: none; border-radius: 8px; font-size: 16px;
            font-weight: bold; cursor: pointer; margin-top: 5px;
        }
        .secondary-btn {
            background-color: transparent; color: var(--text-main);
            border: 1px solid #e2e8f0; margin-top: 10px; font-size: 14px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Rezervace Knihovna</h1>

    <div class="card">
        <div class="input-group">
            <label>Jm√©no</label>
            <input type="text" id="name" placeholder="Va≈°e jm√©no">
        </div>
        <div class="input-group">
            <label>Datum</label>
            <input type="date" id="date">
        </div>
        <div class="time-row">
            <div class="input-group">
                <label>Od</label>
                <input type="time" id="time_from">
            </div>
            <div class="input-group">
                <label>Do</label>
                <input type="time" id="time_to">
            </div>
        </div>
        <button onclick="createReservation()">Vytvo≈ôit rezervaci</button>
        <button class="secondary-btn" onclick="deleteByToken()">M√°m k√≥d pro zru≈°en√≠</button>
    </div>

    <h2>P≈ôehled slot≈Ø</h2>
    <div id="reservation-list" class="card"></div>

    <hr style="margin: 40px 0; border: 0; border-top: 1px solid #e2e8f0;">
    
    <div id="admin-history-section" style="width: 100%;">
        <button class="secondary-btn" onclick="showHistory()">Zobrazit historii (Admin)</button>
        <div id="history-content" style="display:none; margin-top: 20px;" class="card">
            <h3>Kompletn√≠ historie</h3>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                    <thead>
                        <tr style="border-bottom: 2px solid #e2e8f0; text-align: left;">
                            <th style="padding: 8px;">Datum</th>
                            <th style="padding: 8px;">ƒåas</th>
                            <th style="padding: 8px;">Jm√©no</th>
                            <th style="padding: 8px;">Stav</th>
                        </tr>
                    </thead>
                    <tbody id="history-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    const dateInput = document.getElementById('date');
    const today = new Date().toISOString().split("T")[0];
    dateInput.min = today;
    dateInput.value = today;
    dateInput.addEventListener('change', loadReservations);

    async function loadReservations() {
        const selectedDate = dateInput.value;
        const list = document.getElementById('reservation-list');
        list.innerHTML = "Naƒç√≠t√°m...";
        try {
            const res = await fetch(`/reservations?date=${selectedDate}`);
            const data = await res.json();
            list.innerHTML = "";

            for (let hour = 6; hour <= 21; hour++) {
                const timeString = String(hour).padStart(2, '0') + ":00";
                const reservation = data.find(r => {
                    const from = r.time_from.substring(0, 5);
                    const to = r.time_to.substring(0, 5);
                    const [fH, fM] = from.split(':').map(Number);
                    const [tH, tM] = to.split(':').map(Number);
                    const fromTotal = fH * 60 + fM;
                    const toTotal = tH * 60 + tM;
                    const slotStart = hour * 60;
                    const slotEnd = (hour + 1) * 60;
                    return fromTotal < slotEnd && toTotal > slotStart;
                });

                const div = document.createElement('div');
                div.className = "time-slot " + (reservation ? "busy" : "free");

                if (reservation) {
                    const from = reservation.time_from.substring(0, 5);
                    const note = (from.endsWith(":00")) ? "" : ` (od ${from})`;
                    div.innerHTML = `<span>‚è∞ ${timeString}${note}</span><span>üë§ ${reservation.name}</span>`;
                    div.onclick = () => adminDelete(reservation.id);
                } else {
                    div.innerHTML = `<span>‚è∞ ${timeString}</span><span>üîì Volno</span>`;
                    div.onclick = () => {
                        document.getElementById('time_from').value = timeString;
                        document.getElementById('time_to').value = String(hour + 1).padStart(2, '0') + ":00";
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    };
                }
                list.appendChild(div);
            }
        } catch (err) { list.innerHTML = "Chyba p≈ôi naƒç√≠t√°n√≠."; }
    }

    async function createReservation() {
        const name = document.getElementById('name').value;
        const date = document.getElementById('date').value;
        const time_from = document.getElementById('time_from').value;
        const time_to = document.getElementById('time_to').value;
        if (!name || !date || !time_from || !time_to) { alert("Vypl≈àte pole."); return; }

        const res = await fetch('/reserve', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ name, date, time_from, time_to })
        });
        const result = await res.json();
        if (result.success) {
            alert("Ulo≈æeno! K√≥d: " + result.token);
            loadReservations();
        } else { alert(result.message); }
    }

    async function deleteByToken() {
        let token = prompt("Zadejte 4-m√≠stn√Ω k√≥d:");
        if (!token) return;
        const res = await fetch('/delete-own', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ token: token.trim() })
        });
        const result = await res.json();
        if (result.success) { alert("Zru≈°eno."); loadReservations(); }
        else { alert(result.message); }
    }

    async function adminDelete(id) {
        const adminPassword = prompt("Admin heslo:");
        if (!adminPassword) return;
        const res = await fetch('/delete', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ id, adminPassword })
        });
        const result = await res.json();
        if (result.success) { alert("Smaz√°no."); loadReservations(); }
        else { alert("Chyba."); }
    }

    async function showHistory() {
        const adminPassword = prompt("Admin heslo:");
        if (!adminPassword) return;
        const res = await fetch('/history', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ adminPassword })
        });
        const result = await res.json();
        if (result.success) {
            const tbody = document.getElementById('history-table-body');
            tbody.innerHTML = "";
            result.history.forEach(item => {
                const isCancelled = item.status === 'cancelled';
                const row = document.createElement('tr');
                row.style.color = isCancelled ? "#94a3b8" : "inherit";
                row.style.textDecoration = isCancelled ? "line-through" : "none";
                row.innerHTML = `<td style="padding:8px">${item.date}</td><td style="padding:8px">${item.time_from}-${item.time_to}</td><td style="padding:8px">${item.name}</td><td style="padding:8px">${isCancelled ? 'Zru≈°eno' : 'Aktivn√≠'}</td>`;
                tbody.appendChild(row);
            });
            document.getElementById('history-content').style.display = "block";
        } else { alert("≈†patn√© heslo."); }
    }
    loadReservations();
</script>
</body>
</html>
